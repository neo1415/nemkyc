rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Helper Functions ==========

    function getUserRole() {
      return get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role;
    }

    // Normalize known role variants to canonical values using ternary expressions
    function normalizedRole() {
      return getUserRole() == 'superAdmin' || getUserRole() == 'super-admin' || getUserRole() == 'super_admin' || getUserRole() == 'Super Admin' || getUserRole() == 'SuperAdmin'
        ? 'super admin'
        : (getUserRole() == 'user' || getUserRole() == 'User')
          ? 'default'
          : getUserRole();
    }

    function isSuperAdmin() {
      return request.auth != null && normalizedRole() == 'super admin';
    }

    function isAdmin() {
      return request.auth != null && normalizedRole() == 'admin';
    }

    function isCompliance() {
      return request.auth != null && normalizedRole() == 'compliance';
    }

    function isClaims() {
      return request.auth != null && normalizedRole() == 'claims';
    }

    function isBroker() {
      return request.auth != null && normalizedRole() == 'broker';
    }

    function isDefault() {
      return request.auth != null && (normalizedRole() == 'default' || !exists(/databases/$(database)/documents/userroles/$(request.auth.uid)));
    }

    function isAdminOrSuperAdmin() {
      return isAdmin() || isSuperAdmin();
    }

    function isAdminOrCompliance() {
      return isAdmin() || isCompliance() || isSuperAdmin();
    }

    function isClaimsOrAdminOrCompliance() {
      return isClaims() || isAdmin() || isCompliance() || isSuperAdmin();
    }

    function isBrokerOrAdminOrCompliance() {
      return isBroker() || isAdmin() || isCompliance() || isSuperAdmin();
    }

    function isAuthenticatedUser() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document (by email)
    // Note: submittedBy stores lowercase email, so we compare with token email lowercased
    function isOwner() {
      return resource.data.submittedBy == request.auth.token.email.lower();
    }
    
    function isOwnerOnCreate() {
      return request.resource.data.submittedBy == request.auth.token.email.lower();
    }

    // ========== /users/{userId} ==========
    
    match /users/{userId} {
      // Users can create their own document with basic fields
      // Role is restricted to 'default' or 'broker' on client-side creation for security
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        (!("role" in request.resource.data) || request.resource.data.role in ['default', 'broker']);

      // Users can read their own document (needed for tour tracking and profile)
      // Admins and super admins can read any user document
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        isAdminOrSuperAdmin()
      );
      
      // Users can update their own document (for tour completion, profile updates, etc.)
      // Admins can update any user document (for role changes)
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        isAdminOrSuperAdmin()
      );
      
      // Only super admins can delete user documents
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== /userroles/{userId} ==========

    match /userroles/{userId} {
      // Users can create their own document with basic fields
      // Role is restricted to 'default' or 'user' on client-side creation for security
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        (!("role" in request.resource.data) || request.resource.data.role in ['default', 'user']);

      // Users can read their own document, super admins can read any
      // Note: We check super admin role directly here to avoid circular dependency
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        (exists(/databases/$(database)/documents/userroles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role in ['super admin', 'superAdmin', 'super-admin', 'SuperAdmin'])
      );
      
      // Users can update their own document (including tour fields)
      // Super admins can update any document
      // Tour fields: onboardingTourStep, onboardingTourStartedAt, onboardingTourLastAction, onboardingTourCompleted
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        (exists(/databases/$(database)/documents/userroles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role in ['super admin', 'superAdmin', 'super-admin', 'SuperAdmin'])
      );
      
      // Only super admins can delete
      allow delete: if request.auth != null &&
        exists(/databases/$(database)/documents/userroles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role in ['super admin', 'superAdmin', 'super-admin', 'SuperAdmin'];
    }

    // ========== KYC & CDD Collections ==========

    match /partners-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /individual-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /individual-kyc-forms/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /Individual-kyc-form/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc-form/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc-forms/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /agents-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /brokers-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /naicom-partners-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /naicom-corporate-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /brokers-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /agentsCDD/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /partnersCDD/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser();
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== Claims Collections ==========

    match /motor-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /public-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /rent-assurance-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /professional-indemnity-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /employers-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /goods-in-transit-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fire-special-perils-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /group-personal-accident-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /combined-gpa-employers-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /burglary-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /all-risk-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /money-insurance-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fidelity-guarantee-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }
    
    match /contractors-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== Legacy Claims Collections (camelCase - backward compatibility) ==========

    match /goodsInTransitClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fireAndSpecialPerilsClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /groupPersonalAccidentClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fidelityGuaranteeClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow create: if isAuthenticatedUser();
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && isOwner());
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== Identity Collection System ==========

    // Identity lists - Admin and broker access with ownership filtering
    match /identity-lists/{docId} {
      // Brokers can read their own lists, admins/compliance can read all
      allow read: if isAdminOrSuperAdmin() || isCompliance() || 
        (isBroker() && resource.data.createdBy == request.auth.uid);
      
      // Brokers and admins can create lists (createdBy must match their UID)
      allow create: if (isBroker() || isAdminOrSuperAdmin()) && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Brokers can update their own lists, admins can update all
      allow update: if isAdminOrSuperAdmin() || 
        (isBroker() && resource.data.createdBy == request.auth.uid);
      
      // Brokers can delete their own lists, admins can delete all
      allow delete: if isAdminOrSuperAdmin() || 
        (isBroker() && resource.data.createdBy == request.auth.uid);
    }

    // Identity entries - Admin and broker access with list ownership filtering
    // SECURITY: Encrypted identity fields (nin, bvn, cac) are only written by backend service account
    // Client-side writes are restricted to prevent tampering with encrypted data
    match /identity-entries/{docId} {
      // Brokers can read entries from their own lists, admins/compliance can read all
      allow read: if isAdminOrSuperAdmin() || isCompliance() || 
        (isBroker() && exists(/databases/$(database)/documents/identity-lists/$(resource.data.listId)) &&
         get(/databases/$(database)/documents/identity-lists/$(resource.data.listId)).data.createdBy == request.auth.uid);
      
      // Brokers and admins can create entries (via list creation)
      // Note: Encrypted fields (nin, bvn, cac) are only set by backend API
      allow create: if isBroker() || isAdminOrSuperAdmin();
      
      // Brokers can update entries from their own lists, admins can update all
      // Note: Customer verification updates (including encrypted fields) are handled by backend API only
      // Client updates must not modify encrypted identity fields
      allow update: if (isAdminOrSuperAdmin() || 
        (isBroker() && exists(/databases/$(database)/documents/identity-lists/$(resource.data.listId)) &&
         get(/databases/$(database)/documents/identity-lists/$(resource.data.listId)).data.createdBy == request.auth.uid)) &&
        // Prevent client-side modification of encrypted identity fields
        (!request.resource.data.keys().hasAny(['nin', 'bvn', 'cac']) ||
         (request.resource.data.get('nin', null) == resource.data.get('nin', null) &&
          request.resource.data.get('bvn', null) == resource.data.get('bvn', null) &&
          request.resource.data.get('cac', null) == resource.data.get('cac', null)));
      
      // Brokers can delete entries from their own lists, admins can delete all
      allow delete: if isAdminOrSuperAdmin() || 
        (isBroker() && exists(/databases/$(database)/documents/identity-lists/$(resource.data.listId)) &&
         get(/databases/$(database)/documents/identity-lists/$(resource.data.listId)).data.createdBy == request.auth.uid);
    }

    // Identity activity logs - Append-only for system, read for admins and brokers
    match /identity-logs/{docId} {
      // Brokers can read logs for their own lists, admins/compliance can read all
      allow read: if isAdminOrSuperAdmin() || isCompliance() || 
        (isBroker() && exists(/databases/$(database)/documents/identity-lists/$(resource.data.listId)) &&
         get(/databases/$(database)/documents/identity-lists/$(resource.data.listId)).data.createdBy == request.auth.uid);
      
      // Activity logs are created by the backend system only
      // No direct client writes allowed - all writes go through backend API
      allow create: if false;
      // Activity logs are immutable - no updates allowed
      allow update: if false;
      // Activity logs cannot be deleted
      allow delete: if false;
    }

    // ========== Legacy Remediation Collections (backward compatibility) ==========

    // Remediation batches - Admin only access
    match /remediation-batches/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if isAdminOrSuperAdmin() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAdminOrSuperAdmin();
      allow delete: if isAdminOrSuperAdmin();
    }

    // Remediation records
    match /remediation-records/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if isAdminOrSuperAdmin();
      allow update: if isAdminOrSuperAdmin();
      allow delete: if isAdminOrSuperAdmin();
    }

    // Remediation audit logs
    match /remediation-audit-logs/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ========== General fallback ==========

    match /{document=**} {
      allow read: if isAdminOrSuperAdmin();
      allow write: if false;
    }
  }
}