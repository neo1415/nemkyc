rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Helper Functions ==========

    function getUserRole() {
      return get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role;
    }

    // Normalize known role variants to canonical values using ternary expressions
    function normalizedRole() {
      return getUserRole() == 'superAdmin' || getUserRole() == 'super-admin' || getUserRole() == 'super_admin' || getUserRole() == 'Super Admin' || getUserRole() == 'SuperAdmin'
        ? 'super admin'
        : (getUserRole() == 'user' || getUserRole() == 'User')
          ? 'default'
          : getUserRole();
    }

    function isSuperAdmin() {
      return request.auth != null && normalizedRole() == 'super admin';
    }

    function isAdmin() {
      return request.auth != null && normalizedRole() == 'admin';
    }

    function isCompliance() {
      return request.auth != null && normalizedRole() == 'compliance';
    }

    function isClaims() {
      return request.auth != null && normalizedRole() == 'claims';
    }

    function isDefault() {
      return request.auth != null && (normalizedRole() == 'default' || !exists(/databases/$(database)/documents/userroles/$(request.auth.uid)));
    }

    function isAdminOrSuperAdmin() {
      return isAdmin() || isSuperAdmin();
    }

    function isAdminOrCompliance() {
      return isAdmin() || isCompliance() || isSuperAdmin();
    }

    function isClaimsOrAdminOrCompliance() {
      return isClaims() || isAdmin() || isCompliance() || isSuperAdmin();
    }

    function isAuthenticatedUser() {
      return request.auth != null;
    }

    // ========== /userroles/{userId} ==========

    match /userroles/{userId} {
      // Users can create their own document with basic fields
      // Role is restricted to 'default' or 'user' on client-side creation for security
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        (!("role" in request.resource.data) || request.resource.data.role in ['default', 'user']);

      // Users can read their own document, super admins can read any
      // Note: We check super admin role directly here to avoid circular dependency
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        (exists(/databases/$(database)/documents/userroles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role in ['super admin', 'superAdmin', 'super-admin', 'SuperAdmin'])
      );
      
      // Only super admins can update or delete
      allow update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/userroles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userroles/$(request.auth.uid)).data.role in ['super admin', 'superAdmin', 'super-admin', 'SuperAdmin'];
    }

    // ========== KYC & CDD Collections ==========

    match /partners-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /individual-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /individual-kyc-forms/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /Individual-kyc-form/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc-form/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /corporate-kyc-forms/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /agents-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /brokers-kyc/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /naicom-partners-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /naicom-corporate-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /brokers-cdd/{docId} {
      allow read: if isAdminOrCompliance() || isClaims() || isDefault();
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isAdminOrCompliance() || (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== Claims Collections ==========

    match /motor-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /public-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /rent-assurance-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /professional-indemnity-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /employers-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /goodsInTransitClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fireAndSpecialPerilsClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /groupPersonalAccidentClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /combined-gpa-employers-liability-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /burglary-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /all-risk-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /money-insurance-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    match /fidelityGuaranteeClaims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }
    
    match /contractors-claims/{docId} {
      allow read: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow create: if isAuthenticatedUser() && request.resource.data.submittedBy == request.auth.uid;
      allow update: if isClaimsOrAdminOrCompliance() || 
        (isAuthenticatedUser() && resource.data.submittedBy == request.auth.uid);
      allow delete: if isAdminOrSuperAdmin();
    }

    // ========== Identity Collection System ==========

    // Identity lists - Admin only access (uploaded customer lists)
    match /identity-lists/{docId} {
      // Admins, super admins, and compliance can read lists
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      // Only admins and super admins can create lists
      allow create: if isAdminOrSuperAdmin() && 
        request.resource.data.createdBy == request.auth.uid;
      // Only admins and super admins can update lists
      allow update: if isAdminOrSuperAdmin();
      // Admins and super admins can delete lists
      allow delete: if isAdminOrSuperAdmin();
    }

    // Identity entries - Admin write, public read handled by backend via token
    match /identity-entries/{docId} {
      // Admins, super admins, and compliance can read all entries
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      // Only admins and super admins can create entries (via list creation)
      allow create: if isAdminOrSuperAdmin();
      // Only admins and super admins can update entries
      // Note: Customer verification updates are handled by backend API
      allow update: if isAdminOrSuperAdmin();
      // Admins and super admins can delete entries
      allow delete: if isAdminOrSuperAdmin();
    }

    // Identity activity logs - Append-only for system, read for admins
    match /identity-logs/{docId} {
      // Admins, super admins, and compliance can read activity logs
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      // Activity logs are created by the backend system only
      // No direct client writes allowed - all writes go through backend API
      allow create: if false;
      // Activity logs are immutable - no updates allowed
      allow update: if false;
      // Activity logs cannot be deleted
      allow delete: if false;
    }

    // ========== Legacy Remediation Collections (backward compatibility) ==========

    // Remediation batches - Admin only access
    match /remediation-batches/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if isAdminOrSuperAdmin() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAdminOrSuperAdmin();
      allow delete: if isAdminOrSuperAdmin();
    }

    // Remediation records
    match /remediation-records/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if isAdminOrSuperAdmin();
      allow update: if isAdminOrSuperAdmin();
      allow delete: if isAdminOrSuperAdmin();
    }

    // Remediation audit logs
    match /remediation-audit-logs/{docId} {
      allow read: if isAdminOrSuperAdmin() || isCompliance();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ========== General fallback ==========

    match /{document=**} {
      allow read: if isAdminOrSuperAdmin();
      allow write: if false;
    }
  }
}